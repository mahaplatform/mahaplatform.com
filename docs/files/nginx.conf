worker_processes  1;
error_log  logs/error.log;

events {
  worker_connections  1024;
}

http {
  passenger_root /usr/local/rvm/gems/ruby-2.4.1/gems/passenger-5.1.6;
  passenger_ruby /usr/local/rvm/gems/ruby-2.4.1/wrappers/ruby;
  passenger_nodejs /usr/local/bin/node;
  include       mime.types;
  default_type  application/octet-stream;
  sendfile        on;
  keepalive_timeout  65;

  server {
    listen       80;
    server_name  staging.mahaplatform.com;
    passenger_enabled on;
    passenger_app_env staging;
    root /var/www/maha/staging/current/public;
    passenger_app_root /var/www/maha/staging/current;
    passenger_document_root /var/www/maha/staging/current/public;
    passenger_enabled on;
    passenger_app_group_name staging_web;
    passenger_startup_file dist/server.js;
    passenger_app_type node;
    passenger_env_var NODE_PATH /usr/local/rvm/gems/ruby-2.4.1/gems/passenger-5.1.6/src/nodejs_supportlib:/var/www/maha/staging/current/dist:/var/www/maha/staging/current/node_modules;
    gzip  on;
    gzip_http_version 1.1;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_proxied any;
    gzip_types text/plain text/css application/json application/javascript application/x-javascript text/javascript text/xml application/xml application/rss+xml application/atom+xml application/rd
f+xml;
    gzip_buffers 16 8k;
    gzip_disable "MSIE [1-6].(?!.*SV1)";
    gzip_disable "^Mozilla/4\.0[678]";
  }

  server {
    listen       80;
    server_name  localhost;
    passenger_enabled on;
    passenger_app_env production;
    root /var/www/maha/production/current/public;
    passenger_app_root /var/www/maha/production/current;
    passenger_document_root /var/www/maha/production/current/public;
    passenger_enabled on;
    passenger_app_group_name production_web;
    passenger_startup_file dist/server.js;
    passenger_app_type node;
    passenger_env_var NODE_PATH /usr/local/rvm/gems/ruby-2.4.1/gems/passenger-5.1.6/src/nodejs_supportlib:/var/www/maha/production/current/dist:/var/www/maha/production/current/node_modules;
    gzip  on;
    gzip_http_version 1.1;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_proxied any;
    gzip_types text/plain text/css application/json application/javascript application/x-javascript text/javascript text/xml application/xml application/rss+xml application/atom+xml application/rd
f+xml;
    gzip_buffers 16 8k;
    gzip_disable "MSIE [1-6].(?!.*SV1)";
    gzip_disable "^Mozilla/4\.0[678]";
  }

  server {
    listen 443;
    server_name *.mahaplatform.com;
    root /var/www/maha/production/current/public;
    passenger_app_root /var/www/maha/production/current;
    passenger_document_root /var/www/maha/production/current/public;
    passenger_enabled on;
    passenger_app_env production;
    passenger_app_group_name production_web;
    passenger_startup_file dist/server.js;
    passenger_app_type node;
    passenger_env_var NODE_PATH /usr/local/rvm/gems/ruby-2.4.1/gems/passenger-5.1.6/src/nodejs_supportlib:/var/www/maha/production/current/dist:/var/www/maha/production/current/node_modules;
    ssl on;
    ssl_certificate /etc/pki/tls/certs/mahaplatform.com.crt;
    ssl_certificate_key /etc/pki/tls/private/mahaplatform.com.key;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers "ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECD HE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4";
    ssl_prefer_server_ciphers on;
    gzip  on;
    gzip_http_version 1.1;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_proxied any;
    gzip_types text/plain text/css application/json application/javascript application/x-javascript text/javascript text/xml application/xml application/rss+xml application/atom+xml application/rdf
+xml;
    gzip_buffers 16 8k;
    gzip_disable "MSIE [1-6].(?!.*SV1)";
    gzip_disable "^Mozilla/4\.0[678]";

    location / {
      if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Range,Range';
        add_header 'Access-Control-Max-Age' 1728000;
        add_header 'Content-Type' 'text/plain; charset=utf-8';
        add_header 'Content-Length' 0;
        return 204;
      }
      if ($request_method = 'GET') {
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Range,Range';
        add_header 'Access-Control-Expose-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Range,Range';
      }
    }

  }
  server {
    listen 444;
    server_name *.mahaplatform.com;
    root /var/www/maha/production/current/public;
    passenger_app_root /var/www/maha/production/current;
    passenger_document_root /var/www/maha/production/current/public;
    passenger_enabled on;
    passenger_app_env production;
    passenger_app_group_name production_socket;
    passenger_startup_file dist/socket.js;
    passenger_app_type node;
    passenger_env_var NODE_PATH /usr/local/rvm/gems/ruby-2.4.1/gems/passenger-5.1.6/src/nodejs_supportlib:/var/www/maha/production/current/dist:/var/www/maha/production/current/node_modules;
    ssl on;
    ssl_certificate /etc/pki/tls/certs/mahaplatform.com.crt;
    ssl_certificate_key /etc/pki/tls/private/mahaplatform.com.key;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers "ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECD HE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4";
    ssl_prefer_server_ciphers on;
    gzip  on;
    gzip_http_version 1.1;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_proxied any;
    gzip_types text/plain text/css application/json application/javascript application/x-javascript text/javascript text/xml application/xml application/rss+xml application/atom+xml application/rdf
+xml;
    gzip_buffers 16 8k;
    gzip_disable "MSIE [1-6].(?!.*SV1)";
    gzip_disable "^Mozilla/4\.0[678]";
  }

}
