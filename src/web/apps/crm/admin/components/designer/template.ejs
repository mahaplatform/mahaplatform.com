<% block_types = ['h1','h2','h3','h4','p'] %>
<% page_background_color = _.get(page, 'config.background_color', null) %>
<% page_border_top = _.get(page, 'config.border_top', null) %>
<% page_email_border = _.get(page, 'config.email_border', null) %>
<% styles = {} %>
<% block_types.map((block_type, index) => { %>
  <% styles[block_type] = {} %>
  <% styles[block_type].font_family = _.get(page, 'config.'+block_type+'_font_family', null) %>
  <% styles[block_type].font_size = _.get(page, 'config.'+block_type+'_font_size', null) %>
  <% styles[block_type].color = _.get(page, 'config.'+block_type+'_color', null) %>
  <% styles[block_type].bold = _.get(page, 'config.'+block_type+'_bold', null) %>
  <% styles[block_type].italic = _.get(page, 'config.'+block_type+'_italic', null) %>
  <% styles[block_type].text_align = _.get(page, 'config.'+block_type+'_text_align', null) %>
  <% styles[block_type].line_height = _.get(page, 'config.'+block_type+'_line_height', null) %>
  <% styles[block_type].letter_spacing = _.get(page, 'config.'+block_type+'_letter_spacing', null) %>
<% }) %>
<% sections.map((section, i) => { %>
  <% styles['section-'+i] = {} %>
  <% styles['section-'+i].background_color = _.get(section, 'config.background_color', null) %>
  <% styles['section-'+i].background_image = _.get(section, 'config.background_image', null) %>
  <% styles['section-'+i].border_top = _.get(section, 'config.border_top', null) %>
  <% styles['section-'+i].border_bottom = _.get(section, 'config.border_bottom', null) %>
  <% styles['section-'+i].padding_top = _.get(section, 'config.padding_top', null) %>
  <% styles['section-'+i].padding_bottom = _.get(section, 'config.padding_bottom', null) %>
  <% styles['section-'+i].text_font_family = _.get(section, 'config.font_family', null) %>
  <% styles['section-'+i].text_font_size = _.get(section, 'config.font_size', null) %>
  <% styles['section-'+i].text_color = _.get(section, 'config.color', null) %>
  <% styles['section-'+i].text_text_align = _.get(section, 'config.text_align', null) %>
  <% styles['section-'+i].text_line_height = _.get(section, 'config.line_height', null) %>
  <% styles['section-'+i].link_color = _.get(section, 'config.link_color', null) %>
  <% styles['section-'+i].link_bold = _.get(section, 'config.link_bold', null) %>
  <% styles['section-'+i].link_underline = _.get(section, 'config.link_underline', null) %>
  <% styles['section-'+i].letter_spacing = _.get(section, 'config.letter_spacing', null) %>
  <% section.blocks.map((block, j) => { %>
    <% styles['section-'+i+'-block-'+j] = {} %>
    <% styles['section-'+i+'-block-'+j].font_family = _.get(block, 'config.font_family', null) %>
    <% styles['section-'+i+'-block-'+j].font_size = _.get(block, 'config.font_size', null) %>
    <% styles['section-'+i+'-block-'+j].color = _.get(block, 'config.color', null) %>
    <% styles['section-'+i+'-block-'+j].bold = _.get(block, 'config.bold', false) %>
    <% styles['section-'+i+'-block-'+j].italic = _.get(block, 'config.italic', false) %>
    <% styles['section-'+i+'-block-'+j].text_align = _.get(block, 'config.text_align', 'left') %>
    <% styles['section-'+i+'-block-'+j].line_height = _.get(block, 'config.line_height', null) %>
  <% }) %>
<% }) %>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width"/>
    <link href="/admin/css/foundation-emails.min.css" rel="stylesheet" />
    <% if(editable === true) { %>
      <link href="/admin/css/font-awesome.min.css" rel="stylesheet" />
      <style type="text/css">
        .dropzone {
          border: 2px solid transparent;
        }
        .dropzone * {
          pointer-events: none;
        }
        .dropzone.hover {
          border-color: #00B5AD;
          position: relative;
        }
        .dropzone.hover:after {
          position: absolute;
          padding: 5px;
          font-size: 10px;
          top: 0;
          left: 0;
          transform: translate(-2px, -100%);
          background-color: #00B5AD;
          text-transform: uppercase;
          color: white;
        	content: attr(data-label);
        }
        .dropzone-empty {
          padding: 10px 0;
        }
        .dropzone-marker {
          background-color: blue;
          height: 1px;
        }
        .dropzone td.first {
          text-align: center;
        }
        .block {
          margin: -2px;
          pointer-events: auto;
          position: relative;
          cursor: pointer;
          border: 2px solid transparent;
          min-height: 30px;
        }
        .block.active {
          border-color: #00B5AD;
        }
        .block:hover {
          border-color: #00B5AD;
        }
        .block:hover .block-actions {
          display: flex;
        }
        .block-actions {
          display: none;
          position: absolute;
          top: 0;
          right: 0;
          background-color: #00B5AD;
        }
        .block-action {
          pointer-events: auto;
          font-size: 16px;
          padding: 3px 8px;
          line-height: 24px;
        }
        .block-action .fa {
          color: rgba(255,255,255,0.7);
        }
        .block-action:hover .fa {
          color: rgb(255,255,255);
        }
      </style>
    <% } %>
    <style type="text/css">
    @media only screen {
      html {
        background: <%- page_background_color %>;
      }
    }
    table.body {
      border-top: <%- page_border_top %>;
      background: <%- page_background_color %>;
    }
    table.body > tbody > tr > td.float-center {
      padding: 10px;
    }
    td.columns,
    td.column,
    th.columns,
    th.column {
      padding-bottom: 0;
    }
    body,
    table.body,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    p,
    td,
    th,
    a {
      line-height: 1.5;
    }
    table.button table td {
      background-color: #BBBBBB;
      color: #666666;
      border: none;
    }
    <% block_types.map(block_type => { %>
      <%- block_type %> {
        word-wrap: normal;
        margin-bottom: 10px;
        Margin-bottom: 10px;
        <%- styles[block_type].font_family ? 'font-family: '+styles[block_type].font_family+';' : '' %>
        <%- styles[block_type].font_size ? 'font-size: '+styles[block_type].font_size+';' : '' %>
        <%- styles[block_type].bold ? 'font-weight: bold;' : '' %>
        <%- styles[block_type].italic ? 'font-style: italic;' : '' %>
        <%- styles[block_type].color ? 'color: '+styles[block_type].color+';' : '' %>
        <%- styles[block_type].text_align ? 'text-align: '+styles[block_type].text_align+';' : '' %>
        <%- styles[block_type].line_height ? 'line-height: '+styles[block_type].line_height+';' : '' %>
        <%- styles[block_type].letter_spacing ? 'letter-spacing: '+styles[block_type].letter_spacing+';' : '' %>
      }
    <% }) %>

    table.email {
      <%- page_email_border ? 'border: '+page_email_border+';' : '' %>;
    }
    <% sections.map((section, i) => { %>
      table.section-<%- i %> {
        <%- styles['section-'+i].border_top ? 'border-top: '+styles['section-'+i].border_top+';' : '' %>
        <%- styles['section-'+i].border_bottom ? 'border-bottom: '+styles['section-'+i].border_bottom+';' : '' %>
        <%- styles['section-'+i].background_color ? 'background-color: '+styles['section-'+i].background_color+';' : '' %>
      }
      table.section-<%- i %> td,
      table.section-<%- i %> p {
        <%- styles['section-'+i].text_font_family ? 'font-family: '+styles['section-'+i].text_font_family+';' : '' %>
        <%- styles['section-'+i].text_font_size ? 'font-size: '+styles['section-'+i].text_font_size+';' : '' %>
        <%- styles['section-'+i].text_color ? 'color: '+styles['section-'+i].text_color+';' : '' %>
        <%- styles['section-'+i].text_text_align ? 'text-align: '+styles['section-'+i].text_text_align+';' : '' %>
        <%- styles['section-'+i].text_line_height ? 'line-height: '+styles['section-'+i].text_line_height+';' : '' %>
        <%- styles['section-'+i].text_letter_spacing ? 'letter-spacing: '+styles['section-'+i].text_letter_spacing+';' : '' %>
      }
      table.section-<%- i %> td a {
        <%- styles['section-'+i].link_color ? 'font-color: '+styles['section-'+i].link_color+';' : '' %>
        <%- styles['section-'+i].link_bold ? 'font-weight: bold;' : '' %>
        <%- styles['section-'+i].link_underline ? 'text-decoration: underline;' : '' %>
      }
      <% sections[i].blocks.map((block, j) => { %>
        <% style = styles['section-'+i+'-block-'+j] %>
        table.section-<%- i %>-block-<%- j %> td,
        table.section-<%- i %>-block-<%- j %> p {
          <%- style.font_family ? 'font-family: '+style.font_family+';' : '' %>
          <%- style.font_size ? 'font-size: '+style.font_size+';' : '' %>
          <%- style.color ? 'color: '+style.color+';' : '' %>
          <%- style.text_align ? 'text-align: '+style.text_align+';' : '' %>
          <%- style.line_height ? 'line-height: '+style.line_height+';' : '' %>
        }
        <% if(block.type === 'button') { %>
          table.section-<%- i %>-block-<%- j %> table.button table td {
            <%- block.config.border ? 'border:'+block.config.border+';' : '' %>
            <%- block.config.background_color ? 'background-color:'+block.config.background_color+';' : '' %>
            <%- block.config.border_radius ? 'border-radius:'+block.config.border_radius+';' : '' %>
          }
          table.section-<%- i %>-block-<%- j %> table.button table td a {
            <%- block.config.font_family ? 'font-family:'+block.config.font_family+';' : '' %>
            <%- block.config.font_size ? 'font-size:'+block.config.font_size+';' : '' %>
            <%- block.config.letter_spacing ? 'letter-spacing: '+block.config.letter_spacing+';' : '' %>
            <%- block.config.color ? 'color:'+block.config.color+';' : '' %>
            <%- block.config.padding ? 'padding-top:'+block.config.padding+';' : '' %>
            <%- block.config.padding ? 'padding-bottom:'+block.config.padding+';' : '' %>
          }
        <% } else if(block.type === 'text') { %>
          table.section-<%- i %>-block-<%- j %> td,
          table.section-<%- i %>-block-<%- j %> p {
            <%- block.config.font_family ? 'font-family: '+block.config.font_family+';' : '' %>
            <%- block.config.font_size ? 'font-size: '+block.config.font_size+';' : '' %>
            <%- block.config.color ? 'color: '+block.config.color+';' : '' %>
            <%- block.config.text_align ? 'text-align: '+block.config.text_align+';' : '' %>
            <%- block.config.line_height ? 'line-height: '+block.config.line_height+';' : '' %>
            <%- block.config.letter_spacing ? 'letter-spacing: '+block.config.letter_spacing+';' : '' %>
          }
        <% } %>
      <% }) %>
    <% }) %>
    </style>
  </head>
  <body>
    <table class="body">
      <tr>
        <td class="float-center" align="center" valign="top">
          <center>
            <table class="container email">
              <tr>
                <td>
                  <% sections.map((section, i) => { %>
                    <% if(editable === true) { %>
                      <div class="dropzone" data-section="<%= i %>" data-label="<%= section.label %>">
                    <% } %>
                    <table class="section-<%- i %>">
                      <tr>
                        <td>
                          <% if(styles['section-'+i].padding_top) { %>
                            <table class="spacer">
                              <tbody>
                                <tr>
                                  <td height="<%- styles['section-'+i].padding_top %>" style="font-size:<%- styles['section-'+i].padding_top %>;line-height:<%- styles['section-'+i].padding_top %>;">&#xA0;</td>
                                </tr>
                              </tbody>
                            </table>
                          <% } %>
                          <% if(section.blocks.length > 0) { %>
                            <% section.blocks.map((block, j) => { %>
                              <% if(editable === true) { %>
                                <% is_active = active.section === i && active.block === j %>
                                <div class="block<%= is_active ? ' active' : '' %>">
                              <% } %>
                              <% if(block.type === 'text') { %>
                                <table class="row section-<%- i %>-block-<%- j %>">
                                  <tr>
                                    <% columns = block.config.columns %>
                                    <% split = block.config.split %>
                                    <% for(var k = 0; k < columns; k++) { %>
                                      <td class="large-<%- split[k] %><%- k === 0 ? ' first' : '' %><%- k === columns - 1 ? ' last' : '' %> columns">
                                        <%- block.config[`content_${k}`] %>
                                      </td>
                                    <% } %>
                                    <td class="expander"></td>
                                  </tr>
                                </table>
                              <% } else if(block.type === 'divider') { %>
                                <table class="row section-<%- i %>-block-<%- j %>">
                                  <tr>
                                    <td class="large-12 first last columns">
                                      <hr/>
                                    </td>
                                    <td class="expander"></td>
                                  </tr>
                                </table>
                              <% } else if(block.type === 'button') { %>
                                <table class="row section-<%- i %>-block-<%- j %>">
                                  <tr>
                                    <td class="large-12 first last columns">
                                      <% if(block.config.align === 'center') { %>
                                        <center>
                                      <% } %>
                                      <table class="button<%= block.config.display === 'block' ? ' expanded' : '' %> float-<%= block.config.align %>">
                                        <tr>
                                          <td>
                                            <table>
                                              <tr>
                                                <td>
                                                  <% if(block.config.link_strategy === 'web') { %>
                                                    <a href="<%= block.config.url %>"<%- block.config.open_in_new_window ? 'target="_blank"': '' %><%= block.config.title ? ' title="'+block.config.title+'"' : '' %>>
                                                  <% } else if(block.config.link_strategy === 'email') { %>
                                                    <a href="mailto:<%- block.config.email_address %>"<%= block.config.title ? ' title="'+block.config.title+'"' : '' %>>
                                                  <% } else if(block.config.link_strategy === 'anchor') { %>
                                                    <a href="#<%- block.config.anchor %>"<%= block.config.title ? ' title="'+block.config.title+'"' : '' %>>
                                                  <% } else if(block.config.link_strategy === 'asset') { %>
                                                    <a href="<%- block.config.asset_id %>"<%= block.config.title ? ' title="'+block.config.title+'"' : '' %>>
                                                  <% } %>
                                                    <%= block.config.content %>
                                                  </a>
                                                </td>
                                              </tr>
                                            </table>
                                          </td>
                                        </tr>
                                      </table>
                                      <% if(block.config.align === 'center') { %>
                                        </center>
                                      <% } %>
                                    </td>
                                  </tr>
                                </table>
                              <% } else if(block.type === 'images') { %>
                                <%
                                const imagestyle = (style) => {
                                  const styles = []
                                  if(style.width !== null) styles.push('border:'+style.width+'px '+style.style+' '+style.color+';')
                                  if(style.rounded !== null) styles.push('border-radius: '+(25*2)+'%;')
                                  return styles.join('')
                                }
                                %>
                                <% layout = block.settings.layout || [1] %>
                                <% layout.reduce((total, columns) => { %>
                                  <table class="row section-<%- i %>-block-<%- j %>">
                                    <tr>
                                      <% for(var k = 0; k < columns; k++) { %>
                                        <td class="large-<%- 12 / columns %><%- k === 0 ? ' first' : '' %><%- k === columns - 1 ? ' last' : '' %> columns">
                                          <img src="<%- block.content[total + k] %>" style="<%- imagestyle(block.style) %>" />
                                        </td>
                                      <% } %>
                                    </tr>
                                  </table>
                                  <% return total + columns %>
                                <% }, 0) %>
                              <% } %>
                              <% if(editable === true) { %>
                                <div class="block-actions">
                                  <div class="block-spacer"></div>
                                  <div class="block-action" data-action="edit" data-section="<%= i %>" data-block="<%= j %>">
                                    <i class="fa fa-pencil"></i>
                                  </div>
                                  <div class="block-action" data-action="clone" data-section="<%= i %>" data-block="<%= j %>">
                                    <i class="fa fa-copy"></i>
                                  </div>
                                  <div class="block-action" data-action="remove" data-section="<%= i %>" data-block="<%= j %>">
                                    <i class="fa fa-trash"></i>
                                  </div>
                                </div>
                              </div>
                            <% } %>
                            <% }) %>
                          <% } else { %>
                            <div class="dropzone-empty">
                              <table class="row">
                                <tr>
                                  <td class="large-12 first last columns">
                                    <%= section.label %>
                                  </td>
                                  <td class="expander"></td>
                                </tr>
                              </table>
                            </div>
                          <% } %>
                          <% if(styles['section-'+i].padding_bottom) { %>
                            <table class="spacer">
                              <tbody>
                                <tr>
                                  <td height="<%- styles['section-'+i].padding_bottom %>" style="font-size:<%- styles['section-'+i].padding_bottom %>;line-height:<%- styles['section-'+i].padding_bottom %>;">&#xA0;</td>
                                </tr>
                              </tbody>
                            </table>
                          <% } %>
                        </td>
                      </tr>
                    </table>
                    <% if(editable === true) { %>
                      </div>
                    <% } %>
                  <% }) %>
                </td>
              </tr>
            </table>
          </center>
        </td>
      </tr>
      <% if(editable === true) { %>
        <script>

          Array.prototype.map.call(document.getElementsByClassName('block-action'), action => {
            action.addEventListener('click', function(e) {
              const dataset = e.currentTarget.dataset;
              window.parent.postMessage({
                target: 'designer',
                action: dataset.action,
                data: {
                  section: parseInt(dataset.section),
                  block: parseInt(dataset.block)
                }
              }, '*')
            }, false);
          })

          Array.prototype.map.call(document.getElementsByClassName('dropzone'), dropzone => {

            var countdown = 0;

            dropzone.addEventListener('dragenter', function(e) {
              e.preventDefault();
              e.stopPropagation();
              countdown = 1;
              e.currentTarget.className = 'dropzone hover'
            }, false);

            dropzone.addEventListener("dragleave", function(e) {
              e.preventDefault();
              e.stopPropagation();
              e.currentTarget.className = 'dropzone'
            }, false);

            dropzone.addEventListener('dragover', function(e) {
              e.preventDefault();
              e.stopPropagation();
              countdown += 1;
              if(countdown % 30 !== 0) {
                return;
              }
              e.currentTarget.className = 'dropzone hover'
            }, false)

            dropzone.addEventListener('drop', function(e) {
              e.preventDefault()
              e.stopPropagation()
              console.log('dropped', parseInt(e.currentTarget.dataset.section), e.dataTransfer.getData('type'))
              window.parent.postMessage({
                target: 'designer',
                action: 'add',
                data: {
                  section: parseInt(e.currentTarget.dataset.section),
                  type: e.dataTransfer.getData('type')
                }
              }, '*')
            }, false)

            dropzone.addEventListener('dragend', function(e) {
                console.log("Drag End");
            }, false);

          })

        </script>
      <% } %>
    </table>
  </body>
</html>
