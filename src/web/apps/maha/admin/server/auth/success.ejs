<script src="/admin/js/localforage.min.js"></script>

<script>
  localforage.config({
    name: 'local',
    storeName: 'cache'
  });
  localforage.getItem('admin').then(function (admin) {
    if(!admin) {
      admin = {
        teams: []
      }
    }
    const index = admin.teams.reduce((found, team, index) => {
      if(found !== null) return found
      return team.user.id == <%= user.get('id') %> ? index : null
    }, null)
    const team = {
      id: <%= team.get('id') %>,
      title: '<%= team.get('title') %>',
      subdomain: '<%= team.get('subdomain') %>',
      logo: <%- team.related('logo') ? `'${team.related('logo').get('url')}'` : 'null' %>,
      authentication_strategy: '<%= team.get('authentication_strategy') %>',
      token: '<%= token %>',
      user: {
        id: <%= user.get('id') %>,
        email: '<%= user.get('email') %>',
        full_name: '<%= user.get('full_name') %>',
        initials: '<%= user.get('initials') %>',
        photo: <%- user.related('photo') ? `'${user.related('photo').get('url')}'` : 'null' %>
      }
    }
    if(index === null) {
      admin.active = admin.teams.length
      admin.teams.push(team)
    } else {
      admin.active = index
      admin.teams[index] = team
    }
    localforage.setItem('admin', admin).then(function () {
      window.close()
    });
  });
</script>
